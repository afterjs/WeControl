<!DOCTYPE html>
<html lang="pt">
<head>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="au theme template">
    <meta name="author" content="Hau Nguyen">
    <meta name="keywords" content="au theme template">
    <title>WeControl</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animsition/4.0.2/css/animsition.css" rel="stylesheet" media="all">
    <link href="hamburgers/hamburgers.min.css" rel="stylesheet" media="all"> 
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.9/dist/css/bootstrap-select.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/dataTables.bootstrap5.min.css">
    <link href="css/backmain.css" rel="stylesheet" media="all">
    <link href="css/style.css" rel="stylesheet" media="all">
    
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
</head>
<body  class="animsition">
  
  <div class="page-wrapper">
    <!-- MENU TELEMOVEL-->
    <header class="header-mobile d-block d-lg-none">
      <div class="header-mobile__bar">
        <div class="container-fluid">
          <div class="header-mobile-inner">
            <a class="logo menu" data-pagina="" href="#"><img src="img/logo-01.png" id="img-logo" class="img-logo" alt="Cool Admin" style="
              margin-left: auto;
              margin-right: auto;
              display: block;
          "></a>
            <button class="hamburger hamburger--slider" type="button">
              <span class="hamburger-box">
                  <span class="hamburger-inner"></span>
              </span>
             </button>
          </div>
        </div>
      </div>
      <nav class="navbar-mobile">
        <div class="container-fluid">
          <ul class="navbar-mobile__list list-unstyled">
            <li class="has-sub">
              <li>
                <a href="works.html" class="menu"><i class="fas fa-plus"></i>Gerir Trabalhos</a>
              </li>
              <li>
                <a href="users.html" class="menu"><i class="fas fa-plus"></i>Gerir Utilizadores</a>
              </li>
              <li>
                <a href="logs.html" class="menu"><i class="fas fa-id-card"></i>Logs</a>
              </li>
          </li>
      
            <li>
              <a href="#" id="logout-btn" class="menu"><i class="fas fa-sign-out-alt"></i>Logout</a>
            </li>
          </ul>
        </div>
      </nav>
    </header>



    <aside class="menu-sidebar d-none d-lg-block">
      <div class="logo">
        <a href="users.html" class="menu">
          <img src="img/logo-01.png" id="img-logo" class="img-logo" alt="Cool Admin" style="
          margin-left: auto;
          margin-right: auto;
          display: block;
      ">
      </a>
      </div>
      <div class="menu-sidebar__content js-scrollbar1">
        <nav class="navbar-sidebar">
          <ul class="list-unstyled navbar__list">
         
          
            <li class="has-sub">
                <li>
                  <a href="works.html" class="menu"><i class="fas fa-plus"></i>Gerir Trabalhos</a>
                </li>
                <li>
                  <a href="users.html" class="menu"><i class="fas fa-plus"></i>Gerir Utilizadores</a>
                </li>
                <li>
                  <a href="logs.html" class="menu"><i class="fas fa-id-card"></i>Logs</a>
                </li>
            </li>


          </ul>
        </nav>
      </div>
    </aside>

    <div class="page-container">
      <header class="header-desktop" id="header-desktop">
        <div class="section__content section__content--p30">
          <div class="container-fluid">
            <div class="header-wrap">
              <form class="form-header"></form>
              <div class="header-button">
                <div class="account-wrap">
                  <div class="account-item clearfix js-item-menu">
                    <div class="image">
                      <img src="img/logojn.png" alt="Avatar" />
                    </div>
                    <div class="nome-menu">
                      <a>Administração</a>
                    <!-- <i class="fas fa-sms fa-2x" style="color: red;" aria-hidden="true"></i>-->
                      <i class="fas fa-sort-down"></i>
                    </div>
                    <div class="account-dropdown js-dropdown">
                      <div class="info clearfix">
                        <div class="image">
                          <a href="#">
                          <img src="img/logojn.png" alt="John Doe">
                        </a>
                        </div>
                        <div class="content">
                          <h5 class="name">
                            <a href="#">
                              We Control
                            </a>
                          </h5>
                          <span class="email"></span>
                        </div>
                      </div>

                      <div class="account-dropdown__footer">
                        <a href="#" onclick="logout()">
                            <i class="zmdi zmdi-power"></i>Logout</a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </header>
  
      <div class="main-content">
        <div class="section__content section__content--p30">
          <div class="container-fluid">
            <div class="row">
            </div>
            <div class="col-lg-12" style="
    text-align: center;
">
              <div class="table-responsive table--no-card m-b-30">
                <table id="tableUser" class="table table-striped" style="width:100%">
                  <thead>
                      <tr>
                          <th><a href='addWork.html'><i class='fas fa-plus'></i></a>Condutor | ID</th>
                          <th>Camião</th>
                          <th>Partida</th>
                          <th>Destino</th>
                          <th>Data</th>
                          <th>Estado</th>
                      </tr>
                  </thead>
                  <tbody id="tableUsers">
                  </tbody>            
              </table>
              </div>
            </div>
          </div>
        </div>
      </div>
  


<div id="modalEdicaoCampos" class="modalEdicaoCampos"> 
  <div class="modal fade bd-example-modal-lg modalEditar" id="mdlDados" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
        
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        </div>
        <form method="" action="" id="formEditar">

        <div class="modal-body">    
            <input type="hidden" name="editar" id="editar" value="0"/>
            <label class="letra-preta" style="border-bottom: 2px solid #e7422d;  padding-top: 30px;">Informações</label>

            <div class="form-row">

              <div class="form-group col-md-4">
                <label class="letra-preta">Nome</label>
                <input type="text" class="form-control" name="nomeEdit" id="nomeEdit" required disabled>
              </div>

             <div class="form-group col-md-4">
                <label class="letra-preta">Camião</label>
                <input type="text" class="form-control" name="camiaoEdit" id="camiaoEdit" disabled>
              </div>

              <div class="form-group col-md-4">
                <label class="letra-preta">Matricula</label>
                <input type="text" class="form-control" name="matriculaEdit" id="matriculaEdit" disabled>
              </div>

            </div>

<!------------------------------------------------------------DADOS EMPRESARIAIS---------------------------------------------------------------------------->

<label class="letra-preta" style="border-bottom: 2px solid #e7422d;  padding-top: 30px;">Rota e Data</label>

            <div class="form-row">
              
              <div class="form-group col-md-4">
                <label class="letra-preta">Doca Inicial</label>
                <input type="text" class="form-control" name="docaInicialEdit" id="docaInicialEdit" disabled>
              </div>

             <div class="form-group col-md-4">
                <label class="letra-preta">Doca Final</label>
                <input type="text" class="form-control" name="docaFinalEdit" id="docaFinalEdit" disabled>
              </div>

              <div class="form-group col-md-4">
                <label class="letra-preta">Data Inicial</label>
                <input type="text" class="form-control" name="dataInicioEdit" id="dataInicioEdit" disabled>
              </div>

            </div>


            <label class="letra-preta" style="border-bottom: 2px solid #e7422d;  padding-top: 30px;">kilometragem e Estado</label>
            <div class="form-row">
              
              <div class="form-group col-md-4">
                <label class="letra-preta">Kilometro Inicial</label>
                <input type="text" class="form-control" name="klmInicialEdit" id="klmInicialEdit" disabled>
              </div>

             <div class="form-group col-md-4">
                <label class="letra-preta">Kilometro Final</label>
                <input type="text" class="form-control" name="klmFinalEdit" id="klmFinalEdit" required>
              </div>

              <div class="form-group col-md-4">
                <label class="letra-preta">Estado</label>
                <select name="estadoEdit" id="estadoEdit" class="form-control" onchange="enableBTN()">                                  
                  <option value="entregue">ENTREGUE</option>    
                  <option value="carregamento">EM CARREGAMENTO</option>  
                  <option value="movimento">MOVIMENTO</option> 
                </select>
              </div>
              

            </div>

      
          
        </div>
        <div class="modal-footer">
          <button id="apagar" type="button" class="btn btn-primary" style="width: 20%;" >Apagar</button>
          <button id="atualizar" type="button" class="btn btn-primary" style="width: 20%;" >Atualizar</button>
        </div>
           </form>
      </div>
    </div>
  </div>

</div>
      

     

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>            
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/animsition/4.0.2/js/animsition.js"></script>
<script src="https://kit.fontawesome.com/ecfbd6ed72.js" crossorigin="anonymous"></script>
<script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.24/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.9/dist/js/i18n/defaults-pt_BR.min.js"></script>
<script src="js/main.js"></script>
<script src="js/apiSend.js"></script>
<script type="text/javascript">

verificaTipo();
  verificaLogin();


  function enableBTN() {
    $("#atualizar").attr('disabled', false);
  }
 

  $(document).ready(function() {

    let table = $('#tableUser').DataTable();
    let t = $('#tableUser').DataTable();

    let btnApa = document.getElementById("apagar");
    let form = document.getElementById("formEditar");
    let btnAtl = document.getElementById("atualizar");
    let headerWeb = document.getElementById("header-desktop");

  let user = sessionStorage.getItem("username");
  let id = sessionStorage.getItem("identificador");
  let dataInfo;

    let globalId;

    $("#modalEdicaoCampos").on("input", function(){
        $("#atualizar").attr('disabled', false);
    });

  
 
   getUsers();

   function getUsers() {
     axios.get('http://localhost:3000/work/', {
         headers: {
             //Adicionar a Authorization se for necessário e a API estiver bloqueada pelo middleware
              'Authorization': sessionStorage.getItem("token"),
              'Content-Type': 'application/json'
         },
     })
       .then(response => {         
           $.each(response.data, function(i, u) {
            t.row.add( [
                   u.nome + " | " + u.identificador,
                   u.camiao,
                   u.docaInicial,
                   u.docaFinal,
                   u.dataInicio,
                   u.estado.toUpperCase(),
                   
               ] ).node().id = u.idAuto;
           t.draw( false );

           });

       })
       .catch(function (error) {
          
           console.log(error);
       })
       .then(function () {
           // always executed
       });
}




$('#tableUser').on('dblclick', 'tr', function () {
  $("#atualizar").attr('disabled', true);
  var id = table.row( this ).node().id;
  globalId = id;
  axios.get('http://localhost:3000/work/pk/'+id, {
          headers: {
               'Authorization': sessionStorage.getItem("token"),
               'Content-Type': 'application/json'
          },
      })
        .then(response => { 

            document.getElementById("nomeEdit").value = response.data.nome;
            document.getElementById("camiaoEdit").value = response.data.camiao;
            document.getElementById("matriculaEdit").value = response.data.matricula;
            document.getElementById("docaInicialEdit").value = response.data.docaInicial;
            document.getElementById("docaFinalEdit").value = response.data.docaFinal;
            document.getElementById("dataInicioEdit").value = response.data.dataInicio;
            document.getElementById("klmInicialEdit").value = response.data.klmInicial;
            document.getElementById("klmFinalEdit").value = response.data.klmFinal;
            document.getElementById("estadoEdit").value = response.data.estado;

          $('#mdlDados').modal('show'); 
        })
        .catch(function (error) {
            console.log(error);
        })
});


btnApa.addEventListener("click", function () {
  axios.delete('http://localhost:3000/work/'+globalId, {
            headers: {
                //Adicionar a Authorization se for necessário e a API estiver bloqueada pelo middleware
                  'Authorization': sessionStorage.getItem("token"),
                  'Content-Type': 'application/json'
            },
        })
          .then(response => { 
             dataInfo = "O admin " + user + " | " + id + " apagou o trabalho nº" + globalId;
              writeLog(dataInfo);
              $('#mdlDados').modal('hide'); 
              const alert = document.createElement("div");
              alert.classList.add("alert", "alert-success");
              alert.innerText = "Trabalho Apagado.";
              alert.id = "alert"
              headerWeb.prepend(alert);
              setTimeout(function() {
                  document.getElementById("alert").remove();
                  window.location.replace("works.html");
              }, 1000)
          })
          .catch(function (error) {
            const alert = document.createElement("div");
  alert.classList.add("alert", "alert-danger");
  alert.innerText = "Ocorreu um erro.";
  alert.id = "alert"
  headerWeb.prepend(alert);
  setTimeout(function() {
      document.getElementById("alert").remove();
      window.location.replace("works.html");
  }, 1000)
          })
          .then(function () {
              // always executed
          });

})



btnAtl.addEventListener("click", function () {

event.preventDefault();
let formData = new FormData(form);

    let dataString = {
      "estado": $("#estadoEdit").val(),
      "klmFinal": formData.get("klmFinalEdit"),

    };

let data = JSON.stringify(dataString);
console.log(data)

axios.patch("http://localhost:3000/work/" + globalId, data, {
    headers: { 

      'Authorization': sessionStorage.getItem("token"),
      'Content-Type': 'application/json'

    },
})

.then((res) => {
  dataInfo = "O admin " + user + " | " + id + " atualizou o trabalho n º [" + globalId + " ]";
  writeLog(dataInfo);
  $('#mdlDados').modal('hide'); 
  const alert = document.createElement("div");
  alert.classList.add("alert", "alert-success");
  alert.innerText = "Dados Atualizados.";
  alert.id = "alert"
  headerWeb.prepend(alert);
  setTimeout(function() {
      document.getElementById("alert").remove();
      window.location.replace("works.html");
  }, 1000)
})
.catch((error) => {
  const alert = document.createElement("div");
  alert.classList.add("alert", "alert-danger");
  alert.innerText = "Ocorreu um erro.";
  alert.id = "alert"
  headerWeb.prepend(alert);
  setTimeout(function() {
      document.getElementById("alert").remove();
      window.location.replace("works.html");
  }, 1000)
});

})


});

</script>

</body>


</html>